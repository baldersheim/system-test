// Copyright Vespa.ai. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
class MakeDocsUtil

  def hwrite(tmp)
      tmp << "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
      tmp << "\n"
      tmp << "    <!-- WARNING -->\n"
      tmp << "\n"
      tmp << "    <!-- do not edit - generated by #{$0} -->\n"
      tmp << "\n"
      tmp << "    <!-- WARNING -->\n"
      tmp << "\n"
      tmp << "<vespafeed>\n"
      tmp << "  <startoffeed>\n"
      tmp << "    <name>#{@sdname}</name>\n"
      tmp << "    <increment>0</increment>\n"
      tmp << "  </startoffeed>\n"
  end
  def fwrite(tmp)
      tmp << "  <endoffeed>\n"
      tmp << "    <name>#{@sdname}</name>\n"
      tmp << "    <increment>0</increment>\n"
      tmp << "  </endoffeed>\n"
      tmp << "</vespafeed>\n"
  end

  def readnames
    allnames = File.open("lnames", "r") { |f| f.read }
    arr = allnames.split("\n")
    srand 1
    @names = arr.sort_by { rand }
    ## (1..10).each {|x| puts "name #{x}: '#{@names[x]}'" }
  end

  def getyear
    (1698 + rand(42)+rand(42)+rand(42)+rand(42)+rand(42)+rand(42)+rand(42))
  end

  def getprice
    (rand(28000) / 100.0)
  end

  def getlname
    x = @names.shift
    @names.push(x)
    return x
  end

  def getcategory
    if (rand < 0.8) then
      c = "products"
      if (rand < 0.7) then
        c += " / apparel"
        if (rand < 0.3) then 
          c += " / shoes"
        else
          c += " / clothing"
          if (rand < 0.8) then 
            c += " / womens"
            if (rand < 0.04) then 
              c += " / hats"
            elsif  (rand < 0.2)
              c += " / dresses"
            elsif  (rand < 0.3)
              c += " / skirts"
            elsif  (rand < 0.3)
              c += " / pants"
            elsif  (rand < 0.2)
              c += " / gloves"
            elsif  (rand < 0.3)
              c += " / blouses"
            elsif  (rand < 0.3)
              c += " / shirts"
            elsif  (rand < 0.3)
              c += " / shorts"
            elsif  (rand < 0.3)
              c += " / stockings"
            else
              c += " / tops"
            end
          else
            c += " / mens"
          end
        end
      else
        c += " / electronics"
        if (rand < 0.3) then 
          c += " / computers"
        elsif  (rand < 0.3)
          c += " / phones"
        elsif  (rand < 0.3)
          c += " / game consoles"
        elsif  (rand < 0.3)
          c += " / dvd players"
        elsif  (rand < 0.3)
          c += " / hi-fi"
        elsif  (rand < 0.3)
          c += " / photo"
        else
          c += " / TVs and screens"
        end
      end
    else
       c = "services"
       if (rand < 0.7) then
          c += " / phone"
          if (rand < 0.5) then
             c += " / premium with broadband"
          else
             c += " / 300 minutes"
          end
       else
          c += " / mortgage"
          if (rand < 0.3) then
             c += " / subprime"
          else
             c += " / prime"
          end
       end
    end
    return c
  end

  def dwrite(tmp, val)
    @docid += 1
    idv = @docid
    dh = idv % 1234

    tmp << "<document type=\"#{@sdname}\" documentid=\"id:test:#{@sdname}::#{idv}\">\n"
    tmp << "  <title>doc #{idv} hash #{dh} val#{val} type #{@sdname}</title>\n"
    tmp << "  <year>#{getyear}</year>\n"
    tmp << "  <price>#{getprice}</price>\n"
    tmp << "  <lastname>#{getlname}</lastname>\n"
    tmp << "  <category>#{getcategory}</category>\n"
    tmp << "  <myrank>#{idv}</myrank>\n"
    tmp << "</document>\n"

  end

  def dwrite2(tmp, val)
    @docid += 1
    idv = @docid
    dh = (idv % 1423)+7

    tmp << "<document type=\"#{@sdname}\" documentid=\"id:test:#{@sdname}::#{idv}\">\n"
    tmp << "  <name>doc #{idv} hash #{dh} val#{val}</name>\n"
    tmp << "  <year>#{getyear}</year>\n"             if (rand < 0.9)
    tmp << "  <weight>#{getprice}</weight>\n"        if (rand < 0.9)
    tmp << "  <lastname>#{getlname}</lastname>\n"    if (rand < 0.9)
    tmp << "  <category>#{getcategory}</category>\n" if (rand < 0.9)
    tmp << "  <myrank>#{(idv*19)%30 + 1.234}</myrank>\n"
    tmp << "</document>\n"

  end

  def make_file1(numdocs)
    @sdname = "simple"
    @docid = 0
    tmp_file = "docs-#{@sdname}.xml"
    File.open(tmp_file, "w") do |tmp|
      hwrite(tmp)
      (1..numdocs).each { |val| dwrite(tmp, val) }
      fwrite(tmp)
    end
  end

  def make_file2(numdocs)
    @sdname = "strong"
    tmp_file = "docs-#{@sdname}.xml"
    File.open(tmp_file, "w") do |tmp|
      hwrite(tmp)
      (1..numdocs).each { |val| dwrite2(tmp, val) }
      fwrite(tmp)
    end
  end

end

x = MakeDocsUtil.new
x.readnames
x.make_file1(10000)
x.make_file2(30)
